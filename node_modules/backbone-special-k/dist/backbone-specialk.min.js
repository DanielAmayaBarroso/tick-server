!function(e,t){var i={};i.mainContainer="#main",i.ViewManager={currentView:null,mount:function(e){this.unmount(),this.currentView=e;var t=this.currentView.render();t&&$(i.mainContainer).empty().append(t.el).fadeIn("slow")},unmount:function(){return this.currentView?($(i.container).hide(),this.currentView.unbind(),this.currentView.remove(),this.currentView=null,!0):!1}},i.confirm=function(e,t){return t?void t(confirm(e)):console.log("Callback is required for SpecialK.confirm")},i.error=function(e){console.error(e)},i.alert=function(e,t){alert(e),t&&t()},e.SpecialK=i}(window,Backbone),function(e,t,i){e.BaseRouter=e.Router.extend({_routes:{},constructor:function(){this.routeStartPoint&&(this.routes={},this.routes[this.routeStartPoint]="list",this.routes[this.routeStartPoint+"/add"]="form",this.routes[this.routeStartPoint+"/edit/:id"]="edit"),e.Router.prototype.constructor.apply(this,arguments)},cache:!1,modelFetchData:{},editIdNumberInUrl:1,initialize:function(){this.init&&this.init()},list:function(){t.ViewManager.mount(new this.ListView)},form:function(e){var i={};"object"==typeof e&&(i={model:e}),t.ViewManager.mount(new this.FormView(i))},edit:function(){var e,t=arguments[this.editIdNumberInUrl-1],n=this;return this.listView&&(e=this.listView.collection.get(t))?this.form(e):(e=new this.Model,e.set("_id",t),void e.fetch({data:this.modelFetchData,cache:this.cache,success:function(e){n.form(e)},error:function(){i.alert("Error al cargar model de "+n.routeStartPoint)}}))}})}(Backbone,SpecialK,bootbox),function(e,t,i,n){i.Bindings=function(t){t.$el.on("change keyup DOMSubtreeModified","[data-binding]",function(){var i,o,r={};r.$el=e(this),r.key=r.$el.data("binding"),r.value=t.model.get(r.key)||"",r.previusValue=r.value,r.view=t,o=n.modifiers.run(r),o=n.modifiers.normalizeValue(r),i=n.modifiers.normalizeKey(r),t.model.set(i,o)})}}(jQuery,window._,window.Backbone,window.SpecialK),function(e,t,i){var n={};n.renderInput=function(e){t.modifiers.run(e,"before-render");var o=i["tpl/inline-edit-input-text"]({key:e.key,value:e.plainValue}),r=$(o);return r.find(".form-control").on("keydown",n.setKeypress.bind(e)),e.$el.html(r),setTimeout(function(){r.find(".form-control").select()}),r},n.setKeypress=function(e){e.stopPropagation(),27===e.keyCode&&n.renderBackTD(this),13===e.keyCode&&n.saveInput(this)},n.renderBackTD=function(e){var t=e.plainValue;if(e.tplname){t="";try{t=window.JST[e.tplName](e)}catch(i){console.error(i)}}return e.$el.html(t),t},n.saveInput=function(e){i=e.$input.find("input").val(),e.value=i,e.plainValue=i,e=t.modifiers.run(e);var i=t.modifiers.normalizeValue(e),o=e.key.split(".")[0];e.previusValue!==i&&(e.view.model.set(o,i,{silent:!0}),e.view.model.save(null,{silent:!0}),n.renderBackTD(e))},e.InlineEdit=function(e){e.$el.off("dblclick"),e.$el.on("dblclick","td[data-inline-edit]",function(){var t={};t.$el=$(this),t.tplname=t.$el.data("tpl")||null,t.key=t.$el.data("inline-edit"),t.value=e.model.get(t.key)||"",t.plainValue=$(this).text(),t.view=e,t.$input=n.renderInput(t)})}}(window.Backbone,window.SpecialK,window.SK_JST),function(e){e.Model.prototype.save=function(){var t=e.Model.prototype.save;return function(){if("function"==typeof this.before){var e=this.before.call(this,arguments);if(e===!0)return}return t.apply(this,arguments)}}()}(Backbone),function(e,t,i){var n={toTags:function(e){for(var t=e.$el.data("separator")||",",i=e.value.split(t),n=[],o=0,r=i.length;r>=o;o+=1)if(i.hasOwnProperty(o)){var s=i[o].replace(/^\s+|\s+$/gm,"");s&&""!==s&&n.push(s)}return e.value=n,e.plainValue=n.join(","),e},checkbox:function(e){return e.value=!1,e.$input.find('input[type="checkbox"]').is(":checked")&&(e.value=!0),e},toTimestamp:function(e){var t=/^([0-9]{1,2})[\.\-\/]([0-9]{1,2})[\.\-\/]([0-9]{4,4})\s([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})/gi,i=t.exec(e.value);if(!i||7!==i.length)return console.log("valdiation error -- not DMY",e);var n=[[i[3],i[2],i[1]].join("-"),[i[4],i[5],i[6]].join(":")].join(" "),o=new Date(n);return e.value=o.getTime(),e},toFloat:function(e){return e.value=parseFloat(e.value),e},toDmy:function(e){var t=new Date(e.value),i=t.getFullYear(),n=t.getMonth()+1,o=t.getDate(),r=t.getHours(),s=t.getMinutes(),a=t.getSeconds();return 10>n&&(n="0"+n),10>o&&(o="0"+o),10>r&&(r="0"+r),10>s&&(s="0"+s),10>a&&(a="0"+a),o+"-"+n+"-"+i+" "+r+":"+s+":"+a}};i.modifiers={},i.modifiers.add=function(e,t){n[e]=t},i.modifiers.normalizeKey=function(e){return e.key.split(".")[0]},i.modifiers.normalizeValue=function(e){if(e.key.search(/\./)>=0){var t=e.key.split("."),i=e.model||{};i[t[1]]=e.value,e.plainValue||(e.plainValue=i[t[1]]),e.value=i}return e.plainValue||(e.plainValue=e.value),e.value},i.modifiers.run=function(e,t){if(t=t||"modifiers",!e.$el.data(t))return e;for(var i=e.$el.data(t).replace(/\s/g,"").split(","),o=0,r=i.length;r>o;o+=1){var s=i[o];n.hasOwnProperty(s)&&(e=n[s](e))}return e}}(window,Backbone,SpecialK),function(e,t){e.FormView=e.View.extend({tagName:"div",classname:"form-view",Model:null,events:{},_events:{"click .btn-save":"save"},constructor:function(){var t=this;_.forOwn(this._events,function(e,i){t.events[i]=e}),e.View.prototype.constructor.apply(this,arguments)},initialize:function(){this.model||(this.model=new this.Model),this.init&&this.init.apply(this,arguments)},render:function(){return this.renderData=this.model.toJSON()||{},this.beforeRender&&this.beforeRender.apply(this,arguments),this.$el.html(this.template(this.renderData)),this.onRender&&this.onRender.apply(this,arguments),e.Bindings(this),this},save:function(){this.model.save(null,{success:function(){console.log("success")},error:function(e){t.error(e)}})}})}(Backbone,SpecialK),function(){Backbone.ItemView=Backbone.View.extend({tagName:"tr",renderData:null,modalView:null,messages:{removeError:"Ha sucedido un error al eliminar esta entrada.",confirmRemove:"Seguro que quieres eliminar esta entrada?"},events:{},_events:{"click .btn-edit":"editItem","click .btn-remove":"removeItem"},constructor:function(){var e=this;_.forOwn(this._events,function(t,i){e.events[i]=t}),Backbone.View.apply(this,arguments)},initialize:function(e){this.model||(this.model=new this.Model),this.listenTo(this.model,"remove",this.destroy),this.listenTo(this.model,"change",this.render),this.init&&this.init(e)},render:function(){return this.renderData=this.model.toJSON(),this.beforeRender&&this.beforeRender(),this.$el.html(this.template(this.renderData)),this.onRender&&this.onRender(),Backbone.InlineEdit(this),Backbone.Bindings(this),this},destroy:function(){var e=this;this.$el.hide("fast",function(){e.unbind(),e.remove()})},removeItem:function(e){e=e||{};var t=this,i=function(){t.model.destroy({success:function(){t.destroy()},error:function(){SpecialK.alert(t.messages.removeError)}})};e.ctrlKey?i():SpecialK.confirm(this.messages.confirmRemove,function(e){e&&i()})},editItem:function(){if(this.modalView){var e=new this.modalView({model:this.model});e.render()}}})}(),function(e,t){if(!t)throw"Backbone is required";t.ListView=t.View.extend({tagName:"div",className:"list-view",itemsContainer:"tbody",renderData:{},collectionFetchData:{},cache:!1,afterFetch:function(){},Collection:null,ItemView:null,constructor:function(e){t.View.apply(this,[e])},initialize:function(e){e=e||{},this.setupCollection(e),this.init&&this.init(e)},setupCollection:function(e){var t=this;this.collection||(this.collection=new this.Collection(e._collection)),e.data||this.collection.fetch({cache:this.cache,data:this.collectionFetchData,success:function(){t.afterFetch.apply(t,arguments),t.trigger("collection-fetch")}}),this.listenTo(this.collection,"add",this.addItem)},addItem:function(e){e.urlRoot||(e.urlRoot=this.collection.url);var t=new this.ItemView({model:e});this.$(this.itemsContainer).append(t.render().el),this.onAddItem&&this.onAddItem.call(this,e,t)},render:function(){return this.beforeRender&&this.beforeRender(),this.$el.html(this.template(this.renderData)),this.onRender&&this.onRender(),this}})}(window,Backbone),function(e,t){t.ModalView=t.View.extend({tagName:"div",className:"modal fade",attributes:{tabindex:-1,role:"dialog","aria-labelledby":"modal-title","aria-hidden":"true"},Model:null,modalOptions:{keyboard:!0,backdrop:"static",show:!0},changed:!1,events:{"click .btn-cancel":"cancel","click .btn-save":"save"},previusAttributes:null,constructor:function(e){t.View.apply(this,[e])},initialize:function(e){var t=this;return this.model||this.Model?(this.model||(this.model=new this.Model),this.previusAttributes=this.model.toJSON(),this.listenTo(this.model,"change",function(){t.changed=!0}),void(this.init&&this.init(e))):console.log("A model is required")},render:function(){var e=this;this.renderData=this.model.toJSON(),this.beforeRender&&this.beforeRender.apply(this,arguments),this.$el.html(this.template(this.renderData)),this.$el.modal(this.modalOptions),this.$el.on("hidden.bs.modal",function(){e.remove(),e.unbind()}),t.Bindings(this),this.onRender&&this.onRender.apply(this,arguments)},cancel:function(){var e=this;return this.changed?SpecialK.confirm("Han habido cambios, salir sin guardar?",function(t){t&&(e.model.isNew()?e.model.destroy():e.model.set(e.previusAttributes),e.$el.modal("hide"))}):(this.model.isNew()&&this.model.destroy(),void this.$el.modal("hide"))},save:function(){this.model.save(null,{success:function(){},error:function(e){console.error(e)}})}})}(window,Backbone);